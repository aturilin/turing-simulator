{% extends "base.html" %}

{% block title %}Practice - Lesson {{ lesson_num }}{% endblock %}

{% block content %}
<div class="practice-page">
    <div class="practice-container">
        <h1>Practice Time!</h1>

        {% if lesson_num == 4 %}
        <!-- Lesson 4: Control the Head -->
        <div class="practice-exercise" id="practice-head">
            <h2>Control the Head</h2>
            <p>Move the head to find the second "1" on the tape.</p>

            <div class="tape-wrapper practice-tape">
                <div class="tape" id="practice-tape">
                    <div class="tape-cell blank">_</div>
                    <div class="tape-cell">0</div>
                    <div class="tape-cell head">1</div>
                    <div class="tape-cell">1</div>
                    <div class="tape-cell blank">_</div>
                </div>
                <div class="head-indicator">HEAD</div>
            </div>

            <div class="head-display">
                <span>Head sees: <strong id="head-sees">1</strong></span>
            </div>

            <div class="practice-controls">
                <button id="btn-left" class="btn-secondary">‚óÄ Left</button>
                <button id="btn-right" class="btn-secondary">Right ‚ñ∂</button>
            </div>

            <div class="practice-result hidden" id="practice-result">
                <p class="success">Great job! You found the second 1!</p>
            </div>
        </div>

        {% elif lesson_num == 5 %}
        <!-- Lesson 5: Design States -->
        <div class="practice-exercise" id="practice-states">
            <h2>Think About States</h2>
            <p><strong>Task:</strong> Determine if there's at least one "1" on the tape.</p>

            <div class="examples-box">
                <p>Examples:</p>
                <ul>
                    <li><code>000</code> ‚Üí NO (no ones)</li>
                    <li><code>010</code> ‚Üí YES (found a one)</li>
                    <li><code>111</code> ‚Üí YES (found ones)</li>
                </ul>
            </div>

            <div class="question-box">
                <p><strong>What does the machine need to "remember"?</strong></p>
                <textarea id="memory-answer" placeholder="Type your answer..."></textarea>
            </div>

            <div class="states-builder">
                <h3>Your States:</h3>
                <div class="start-state">
                    <div class="state-badge">üèÅ START</div>
                </div>
                <div id="custom-states"></div>
                <button id="btn-add-state" class="btn-small btn-secondary">+ Add State</button>
            </div>

            <button id="btn-check-states" class="btn-primary">Check My Answer</button>

            <div class="feedback-box hidden" id="feedback-box">
                <p id="feedback-message"></p>
            </div>
        </div>

        {% elif lesson_num == 6 %}
        <!-- Lesson 6: Apply a Rule -->
        <div class="practice-exercise" id="practice-rules">
            <h2>Be the Turing Machine!</h2>
            <p>Apply this rule manually:</p>

            <div class="rule-display">
                <p>"In <strong>SCAN</strong>, if I see <strong>1</strong>:</p>
                <ul>
                    <li>‚Üí Write <strong>0</strong></li>
                    <li>‚Üí Move <strong>RIGHT</strong></li>
                    <li>‚Üí Go to <strong>ADD</strong>"</li>
                </ul>
            </div>

            <div class="current-situation">
                <p>Current state: <strong>SCAN</strong></p>
                <div class="tape-wrapper practice-tape">
                    <div class="tape" id="rule-tape">
                        <div class="tape-cell blank">_</div>
                        <div class="tape-cell head">1</div>
                        <div class="tape-cell">0</div>
                        <div class="tape-cell blank">_</div>
                    </div>
                </div>
            </div>

            <div class="action-form">
                <h3>What will you do?</h3>
                <div class="action-row">
                    <label>1. Write:</label>
                    <select id="action-write">
                        <option value="">Select...</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="_">blank</option>
                    </select>
                </div>
                <div class="action-row">
                    <label>2. Move:</label>
                    <select id="action-move">
                        <option value="">Select...</option>
                        <option value="left">Left</option>
                        <option value="right">Right</option>
                        <option value="stay">Stay</option>
                    </select>
                </div>
                <div class="action-row">
                    <label>3. New state:</label>
                    <select id="action-state">
                        <option value="">Select...</option>
                        <option value="SCAN">SCAN</option>
                        <option value="ADD">ADD</option>
                        <option value="DONE">DONE</option>
                    </select>
                </div>

                <button id="btn-apply-rule" class="btn-primary">Apply!</button>
            </div>

            <div class="result-section hidden" id="result-section">
                <h3>Result:</h3>
                <div class="tape-wrapper practice-tape">
                    <div class="tape" id="result-tape"></div>
                </div>
                <p id="result-state"></p>
            </div>
        </div>

        {% elif lesson_num == 7 %}
        <!-- Lesson 7: Trace Execution -->
        <div class="practice-exercise" id="practice-trace">
            <h2>Trace the Algorithm</h2>
            <p>Follow "Add 1" on the number 11 (binary)</p>

            <div class="trace-step" id="trace-step">
                <p>Step <span id="step-num">1</span>:</p>
                <div class="tape-wrapper practice-tape">
                    <div class="tape" id="trace-tape"></div>
                </div>
                <p>State: <strong id="trace-state">SCAN</strong>, sees: <strong id="trace-symbol">1</strong></p>
            </div>

            <div class="question-box">
                <p>What rule applies? What happens next?</p>
                <select id="next-rule">
                    <option value="">Select the rule...</option>
                </select>
            </div>

            <button id="btn-check-trace" class="btn-primary">Check</button>

            <div class="feedback-box hidden" id="trace-feedback">
                <p id="trace-feedback-message"></p>
            </div>
        </div>

        {% elif lesson_num == 8 %}
        <!-- Lesson 8: Binary Converter -->
        <div class="practice-exercise" id="practice-binary">
            <h2>Binary Converter</h2>

            <div class="converter-section">
                <h3>Binary ‚Üí Decimal</h3>
                <div class="binary-display">
                    <div class="bit-box" data-value="8">
                        <div class="bit">1</div>
                        <div class="weight">8</div>
                    </div>
                    <div class="bit-box" data-value="4">
                        <div class="bit">0</div>
                        <div class="weight">4</div>
                    </div>
                    <div class="bit-box" data-value="2">
                        <div class="bit">1</div>
                        <div class="weight">2</div>
                    </div>
                    <div class="bit-box" data-value="1">
                        <div class="bit">1</div>
                        <div class="weight">1</div>
                    </div>
                </div>
                <div class="sum-display">
                    = <input type="number" id="decimal-answer" placeholder="?">
                </div>
                <button id="btn-check-binary" class="btn-primary btn-small">Check</button>
            </div>

            <div class="converter-section">
                <h3>Decimal ‚Üí Binary</h3>
                <p>Convert <strong>13</strong> to binary:</p>
                <input type="text" id="binary-answer" placeholder="Enter binary (e.g., 1101)">
                <button id="btn-check-decimal" class="btn-primary btn-small">Check</button>
            </div>

            <div class="feedback-box hidden" id="binary-feedback">
                <p id="binary-feedback-message"></p>
            </div>
        </div>
        {% endif %}

        <div class="practice-nav">
            <a href="/lesson/{{ lesson_num }}" class="btn-secondary">‚Üê Back to Lesson</a>
            {% if lesson_num < 8 %}
            <a href="/lesson/{{ lesson_num + 1 }}" class="btn-primary" id="btn-next-lesson" style="display: none;">
                Next Lesson ‚Üí
            </a>
            {% else %}
            <a href="/simulator" class="btn-success" id="btn-next-lesson" style="display: none;">
                Go to Simulator ‚Üí
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const lessonNum = {{ lesson_num }};
    const nextBtn = document.getElementById('btn-next-lesson');

    function showNextButton() {
        if (nextBtn) nextBtn.style.display = 'inline-block';
    }

    {% if lesson_num == 4 %}
    // Head control practice
    const tapeCells = document.querySelectorAll('#practice-tape .tape-cell');
    let headPos = 2; // Starting position

    function updateHead() {
        tapeCells.forEach((cell, i) => cell.classList.remove('head'));
        tapeCells[headPos].classList.add('head');
        document.getElementById('head-sees').textContent = tapeCells[headPos].textContent || '_';

        // Check if found second 1 (position 3)
        if (headPos === 3) {
            document.getElementById('practice-result').classList.remove('hidden');
            showNextButton();
        }
    }

    document.getElementById('btn-left').addEventListener('click', () => {
        if (headPos > 0) { headPos--; updateHead(); }
    });
    document.getElementById('btn-right').addEventListener('click', () => {
        if (headPos < tapeCells.length - 1) { headPos++; updateHead(); }
    });

    {% elif lesson_num == 6 %}
    // Rule application practice
    document.getElementById('btn-apply-rule').addEventListener('click', function() {
        const write = document.getElementById('action-write').value;
        const move = document.getElementById('action-move').value;
        const state = document.getElementById('action-state').value;

        if (write === '0' && move === 'right' && state === 'ADD') {
            // Correct!
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('result-tape').innerHTML = `
                <div class="tape-cell blank">_</div>
                <div class="tape-cell">0</div>
                <div class="tape-cell head">0</div>
                <div class="tape-cell blank">_</div>
            `;
            document.getElementById('result-state').innerHTML = '<span class="success">‚úì Correct! State: ADD</span>';
            showNextButton();
        } else {
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('result-state').innerHTML = '<span class="error">Not quite. Re-read the rule and try again!</span>';
        }
    });

    {% elif lesson_num == 8 %}
    // Binary converter practice
    document.getElementById('btn-check-binary').addEventListener('click', function() {
        const answer = parseInt(document.getElementById('decimal-answer').value);
        const feedback = document.getElementById('binary-feedback');
        const message = document.getElementById('binary-feedback-message');

        feedback.classList.remove('hidden');
        if (answer === 11) { // 1011 = 8+0+2+1 = 11
            message.innerHTML = '<span class="success">‚úì Correct! 1011 = 8+2+1 = 11</span>';
            showNextButton();
        } else {
            message.innerHTML = '<span class="error">Try again. Add up: 8 + 0 + 2 + 1 = ?</span>';
        }
    });

    document.getElementById('btn-check-decimal').addEventListener('click', function() {
        const answer = document.getElementById('binary-answer').value.trim();
        const feedback = document.getElementById('binary-feedback');
        const message = document.getElementById('binary-feedback-message');

        feedback.classList.remove('hidden');
        if (answer === '1101') { // 13 = 8+4+0+1 = 1101
            message.innerHTML = '<span class="success">‚úì Correct! 13 = 8+4+1 = 1101</span>';
            showNextButton();
        } else {
            message.innerHTML = '<span class="error">Try again. 13 = 8 + 4 + 0 + 1</span>';
        }
    });
    {% endif %}
});
</script>
{% endblock %}
