{% extends "base.html" %}

{% block title %}Rules for {{ state_name }} - Challenge{% endblock %}

{% block content %}
<div class="challenge-page">
    <div class="challenge-container">
        <h1>Step 2: Rules for <span class="current-state">{{ state_name }}</span></h1>

        <!-- Progress indicator -->
        <div class="progress-bar" id="progress-bar">
            <!-- Filled by JS -->
        </div>

        <!-- Task reminder -->
        <div class="challenge-reminder" id="challenge-reminder">
            <!-- Task reminder loads here -->
        </div>

        <!-- Clear explanation for this state -->
        <div class="state-explanation">
            <h3>What should happen in {{ state_name }}?</h3>
            <p>Define what the machine does when it's in <strong>{{ state_name }}</strong> state and sees each symbol.</p>

            <div class="rule-template">
                <strong>Each rule says:</strong><br>
                "When I see [symbol] → write [something], move [direction], go to [next state]"
            </div>
        </div>

        <!-- Rules form -->
        <div class="rules-form-section">
            <div class="rule-cards">
                <!-- Rule for 0 -->
                <div class="rule-card-input">
                    <div class="rule-card-header">
                        <span class="symbol">0</span>
                        When I see <strong>0</strong>
                    </div>
                    <div class="rule-card-body">
                        <div class="rule-field">
                            <label>Write:</label>
                            <select id="rule-0-write">
                                <option value="0">0 (keep it)</option>
                                <option value="1">1</option>
                                <option value="_">blank</option>
                            </select>
                        </div>
                        <div class="rule-field">
                            <label>Move:</label>
                            <select id="rule-0-move">
                                <option value="right">Right →</option>
                                <option value="left">← Left</option>
                                <option value="stay">Stay (don't move)</option>
                            </select>
                        </div>
                        <div class="rule-field">
                            <label>Go to state:</label>
                            <select id="rule-0-goto" class="state-select"></select>
                        </div>
                    </div>
                </div>

                <!-- Rule for 1 -->
                <div class="rule-card-input">
                    <div class="rule-card-header">
                        <span class="symbol">1</span>
                        When I see <strong>1</strong>
                    </div>
                    <div class="rule-card-body">
                        <div class="rule-field">
                            <label>Write:</label>
                            <select id="rule-1-write">
                                <option value="1">1 (keep it)</option>
                                <option value="0">0</option>
                                <option value="_">blank</option>
                            </select>
                        </div>
                        <div class="rule-field">
                            <label>Move:</label>
                            <select id="rule-1-move">
                                <option value="right">Right →</option>
                                <option value="left">← Left</option>
                                <option value="stay">Stay (don't move)</option>
                            </select>
                        </div>
                        <div class="rule-field">
                            <label>Go to state:</label>
                            <select id="rule-1-goto" class="state-select"></select>
                        </div>
                    </div>
                </div>

                <!-- Rule for blank -->
                <div class="rule-card-input">
                    <div class="rule-card-header">
                        <span class="symbol blank">_</span>
                        When I see <strong>blank</strong> (end of input)
                    </div>
                    <div class="rule-card-body">
                        <div class="rule-field">
                            <label>Write:</label>
                            <select id="rule-blank-write">
                                <option value="_">blank (keep it)</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                            </select>
                        </div>
                        <div class="rule-field">
                            <label>Move:</label>
                            <select id="rule-blank-move">
                                <option value="stay">Stay (don't move)</option>
                                <option value="left">← Left</option>
                                <option value="right">Right →</option>
                            </select>
                        </div>
                        <div class="rule-field">
                            <label>Go to state:</label>
                            <select id="rule-blank-goto" class="state-select"></select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary of what was defined -->
        <div class="rules-summary" id="rules-summary">
            <h3>Your Rules Summary:</h3>
            <div id="summary-content"></div>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="/challenge/states" class="btn-secondary">← Back to States</a>
            <button id="btn-next" class="btn-primary btn-large">Save & Continue →</button>
        </div>

        <!-- Help section -->
        <div class="help-section hidden" id="help-section">
            <button class="help-toggle" id="help-toggle">Show Answer</button>
            <div class="help-content hidden" id="help-content">
                <p>Loading suggested answer...</p>
            </div>
        </div>
    </div>
</div>

<style>
.current-state {
    background: #dbeafe;
    color: #1d4ed8;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-family: monospace;
}

.progress-bar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.progress-step {
    flex: 1;
    padding: 0.5rem;
    text-align: center;
    background: #f3f4f6;
    border-radius: 4px;
    font-size: 0.85rem;
}

.progress-step.active {
    background: #dbeafe;
    color: #1d4ed8;
    font-weight: 600;
}

.progress-step.done {
    background: #d1fae5;
    color: #059669;
}

.challenge-reminder {
    background: #f3f4f6;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
}

.state-explanation {
    background: #f0f9ff;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border-left: 4px solid #0ea5e9;
}

.rule-template {
    margin-top: 1rem;
    padding: 0.75rem;
    background: white;
    border-radius: 4px;
    font-size: 0.95rem;
}

.rules-form-section {
    margin-bottom: 1.5rem;
}

.rule-cards {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.rule-card-input {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.rule-card-header {
    background: #f9fafb;
    padding: 0.75rem 1rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.symbol {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1f2937;
    color: #10b981;
    border-radius: 4px;
    font-family: monospace;
    font-weight: bold;
}

.symbol.blank {
    color: #6b7280;
}

.rule-card-body {
    padding: 1rem;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

@media (max-width: 600px) {
    .rule-card-body {
        grid-template-columns: 1fr;
    }
}

.rule-field label {
    display: block;
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
}

.rule-field select {
    width: 100%;
    padding: 0.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 4px;
    font-size: 1rem;
}

.rule-field select:focus {
    border-color: #3b82f6;
    outline: none;
}

.rules-summary {
    background: #fefce8;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.summary-rule {
    padding: 0.5rem 0;
    border-bottom: 1px solid #fef3c7;
    font-family: monospace;
}

.summary-rule:last-child {
    border-bottom: none;
}

.nav-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.help-section {
    border-top: 1px solid #e5e7eb;
    padding-top: 1rem;
    margin-top: 1rem;
}

.help-toggle {
    background: #fef2f2;
    color: #dc2626;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
}

.help-content {
    margin-top: 1rem;
    padding: 1rem;
    background: #fef2f2;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentState = '{{ state_name }}';
    const states = JSON.parse(sessionStorage.getItem('challengeStates') || '[]');
    const rules = JSON.parse(sessionStorage.getItem('challengeRules') || '{}');
    const challenge = JSON.parse(sessionStorage.getItem('currentChallenge') || '{}');

    // Show task reminder
    const reminderDiv = document.getElementById('challenge-reminder');
    if (challenge.task) {
        reminderDiv.innerHTML = `<p><strong>Task:</strong> ${challenge.task}</p>`;
    }

    // Build progress bar
    const progressBar = document.getElementById('progress-bar');
    states.forEach((state, idx) => {
        const step = document.createElement('div');
        step.className = 'progress-step';
        if (state.name === currentState) {
            step.classList.add('active');
        } else if (rules[state.name]) {
            step.classList.add('done');
        }
        step.textContent = state.name;
        progressBar.appendChild(step);
    });

    // Populate state selects
    const stateSelects = document.querySelectorAll('.state-select');
    stateSelects.forEach(select => {
        // Add all user states
        states.forEach(state => {
            const option = document.createElement('option');
            option.value = state.name;
            option.textContent = state.name;
            select.appendChild(option);
        });
        // Add DONE option
        const doneOption = document.createElement('option');
        doneOption.value = 'DONE';
        doneOption.textContent = 'DONE (stop machine)';
        select.appendChild(doneOption);
    });

    // Load existing rules for this state if any
    if (rules[currentState]) {
        const r = rules[currentState];
        if (r['0']) {
            document.getElementById('rule-0-write').value = r['0'].write;
            document.getElementById('rule-0-move').value = r['0'].move;
            document.getElementById('rule-0-goto').value = r['0'].goto;
        }
        if (r['1']) {
            document.getElementById('rule-1-write').value = r['1'].write;
            document.getElementById('rule-1-move').value = r['1'].move;
            document.getElementById('rule-1-goto').value = r['1'].goto;
        }
        if (r['_']) {
            document.getElementById('rule-blank-write').value = r['_'].write;
            document.getElementById('rule-blank-move').value = r['_'].move;
            document.getElementById('rule-blank-goto').value = r['_'].goto;
        }
    }

    function getCurrentRules() {
        return {
            '0': {
                write: document.getElementById('rule-0-write').value,
                move: document.getElementById('rule-0-move').value,
                goto: document.getElementById('rule-0-goto').value
            },
            '1': {
                write: document.getElementById('rule-1-write').value,
                move: document.getElementById('rule-1-move').value,
                goto: document.getElementById('rule-1-goto').value
            },
            '_': {
                write: document.getElementById('rule-blank-write').value,
                move: document.getElementById('rule-blank-move').value,
                goto: document.getElementById('rule-blank-goto').value
            }
        };
    }

    function updateSummary() {
        const r = getCurrentRules();
        const moveSymbol = (m) => m === 'right' ? '→' : m === 'left' ? '←' : '•';
        const summaryContent = document.getElementById('summary-content');
        summaryContent.innerHTML = `
            <div class="summary-rule">See 0 → write ${r['0'].write}, ${moveSymbol(r['0'].move)}, go to ${r['0'].goto}</div>
            <div class="summary-rule">See 1 → write ${r['1'].write}, ${moveSymbol(r['1'].move)}, go to ${r['1'].goto}</div>
            <div class="summary-rule">See blank → write ${r['_'].write === '_' ? 'blank' : r['_'].write}, ${moveSymbol(r['_'].move)}, go to ${r['_'].goto}</div>
        `;
    }

    // Update summary on change
    document.querySelectorAll('select').forEach(sel => sel.addEventListener('change', updateSummary));
    updateSummary();

    // Find next state to configure
    const stateIndex = states.findIndex(s => s.name === currentState);
    const nextState = states[stateIndex + 1];

    // Save and continue button
    document.getElementById('btn-next').addEventListener('click', function() {
        // Save current rules
        rules[currentState] = getCurrentRules();
        sessionStorage.setItem('challengeRules', JSON.stringify(rules));

        if (nextState) {
            // Go to next state
            window.location.href = `/challenge/rules/${nextState.name}`;
        } else {
            // All states done, go to test
            window.location.href = '/challenge/run';
        }
    });

    // Help toggle (show answer)
    const helpSection = document.getElementById('help-section');
    const helpToggle = document.getElementById('help-toggle');
    const helpContent = document.getElementById('help-content');

    helpSection.classList.remove('hidden');

    helpToggle.addEventListener('click', async function() {
        if (!helpContent.classList.contains('hidden')) {
            helpContent.classList.add('hidden');
            helpToggle.textContent = 'Show Answer';
            return;
        }

        helpContent.innerHTML = '<p>Loading...</p>';
        helpContent.classList.remove('hidden');
        helpToggle.textContent = 'Hide Answer';

        try {
            const response = await fetch('/api/challenge/get-answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    challenge: challenge,
                    state_name: currentState,
                    all_states: states.map(s => s.name)
                })
            });

            const result = await response.json();

            if (result.rules) {
                const r = result.rules;
                helpContent.innerHTML = `
                    <p><strong>Suggested rules for ${currentState}:</strong></p>
                    <ul>
                        <li>See 0 → write ${r['0']?.write || '?'}, move ${r['0']?.move || '?'}, go to ${r['0']?.goto || '?'}</li>
                        <li>See 1 → write ${r['1']?.write || '?'}, move ${r['1']?.move || '?'}, go to ${r['1']?.goto || '?'}</li>
                        <li>See blank → write ${r['_']?.write || '?'}, move ${r['_']?.move || '?'}, go to ${r['_']?.goto || '?'}</li>
                    </ul>
                    ${result.explanation ? `<p><em>${result.explanation}</em></p>` : ''}
                    <button class="btn-secondary" onclick="applyAnswer()">Apply This Answer</button>
                `;

                window.applyAnswer = function() {
                    if (r['0']) {
                        document.getElementById('rule-0-write').value = r['0'].write;
                        document.getElementById('rule-0-move').value = r['0'].move;
                        document.getElementById('rule-0-goto').value = r['0'].goto;
                    }
                    if (r['1']) {
                        document.getElementById('rule-1-write').value = r['1'].write;
                        document.getElementById('rule-1-move').value = r['1'].move;
                        document.getElementById('rule-1-goto').value = r['1'].goto;
                    }
                    if (r['_']) {
                        document.getElementById('rule-blank-write').value = r['_'].write;
                        document.getElementById('rule-blank-move').value = r['_'].move;
                        document.getElementById('rule-blank-goto').value = r['_'].goto;
                    }
                    updateSummary();
                };
            } else {
                helpContent.innerHTML = '<p>Could not load answer. Try again.</p>';
            }
        } catch (error) {
            helpContent.innerHTML = '<p>Error loading answer.</p>';
        }
    });
});
</script>
{% endblock %}
