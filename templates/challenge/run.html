{% extends "base.html" %}

{% block title %}Test Your Algorithm - Challenge{% endblock %}

{% block content %}
<div class="challenge-page">
    <div class="challenge-container">
        <h1>Step 3: Test Your Algorithm</h1>

        <!-- Task reminder -->
        <div class="challenge-reminder" id="challenge-reminder">
            <!-- Challenge task reminder loads here -->
        </div>

        <!-- Test results summary -->
        <div class="test-results-summary hidden" id="test-results-summary">
            <div class="results-header">
                <span id="results-count">0/0 tests passed</span>
                <span id="results-status" class="status"></span>
            </div>
        </div>

        <!-- Test cases grid -->
        <div class="test-cases-grid" id="test-cases-grid">
            <!-- Test cases render here -->
        </div>

        <!-- Visualization area -->
        <div class="visualization-section hidden" id="visualization-section">
            <h3>Watch the Machine Run</h3>
            <div class="tape-wrapper">
                <div class="tape" id="visual-tape">
                    <!-- Tape cells render here -->
                </div>
                <div class="head-indicator">HEAD</div>
            </div>
            <div class="machine-state">
                <span>State: <strong id="visual-state">START</strong></span>
                <span>Step: <span id="visual-step">0</span></span>
            </div>
            <div class="visual-controls">
                <button id="btn-step" class="btn-secondary">Step</button>
                <button id="btn-run-slow" class="btn-secondary">Run Slow</button>
                <button id="btn-run-fast" class="btn-primary">Run Fast</button>
                <button id="btn-reset-visual" class="btn-secondary">Reset</button>
            </div>
        </div>

        <!-- Final result -->
        <div class="final-result hidden" id="final-result">
            <div class="result-box success hidden" id="result-success">
                <h2>All Tests Passed!</h2>
                <p>Your Turing machine correctly solves the challenge.</p>
                <a href="/challenge" class="btn-primary btn-large">Try Another Challenge</a>
            </div>
            <div class="result-box failure hidden" id="result-failure">
                <h2>Some Tests Failed</h2>
                <p>Check the failed tests above and adjust your rules.</p>
                <a href="/challenge/rules/START" class="btn-secondary">Edit Rules</a>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="/challenge/states" class="btn-secondary">← Edit States</a>
            <button id="btn-run-all-tests" class="btn-primary btn-large">Run All Tests</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const challenge = JSON.parse(sessionStorage.getItem('currentChallenge') || '{}');
    const states = JSON.parse(sessionStorage.getItem('challengeStates') || '[]');
    const rules = JSON.parse(sessionStorage.getItem('challengeRules') || '{}');

    const reminderDiv = document.getElementById('challenge-reminder');
    const testCasesGrid = document.getElementById('test-cases-grid');
    const resultsSummary = document.getElementById('test-results-summary');
    const resultsCount = document.getElementById('results-count');
    const resultsStatus = document.getElementById('results-status');
    const visualSection = document.getElementById('visualization-section');
    const finalResult = document.getElementById('final-result');

    // Show task reminder
    if (challenge.task) {
        reminderDiv.innerHTML = `<p><strong>Task:</strong> ${challenge.task}</p>`;
    }

    // Turing Machine Simulator
    class TuringSimulator {
        constructor(userRules) {
            this.rules = userRules;
            this.reset('');
        }

        reset(input) {
            this.tape = {};
            for (let i = 0; i < input.length; i++) {
                this.tape[i] = input[i];
            }
            this.headPos = 0;
            this.state = 'START';
            this.steps = 0;
            this.halted = false;
        }

        getSymbol() {
            return this.tape[this.headPos] || '_';
        }

        step() {
            if (this.halted) return false;

            const symbol = this.getSymbol();
            const stateRules = this.rules[this.state];

            if (!stateRules || !stateRules[symbol]) {
                this.halted = true;
                return false;
            }

            const rule = stateRules[symbol];
            this.tape[this.headPos] = rule.write;

            if (rule.move === 'right') this.headPos++;
            else if (rule.move === 'left') this.headPos--;

            this.state = rule.goto;

            if (this.state === 'DONE') {
                this.halted = true;
            }

            this.steps++;
            return !this.halted;
        }

        run(maxSteps = 1000) {
            while (!this.halted && this.steps < maxSteps) {
                this.step();
            }
            return {
                halted: this.halted,
                state: this.state,
                output: this.getSymbol(),
                steps: this.steps,
                timeout: this.steps >= maxSteps
            };
        }

        getTapeArray() {
            const positions = Object.keys(this.tape).map(Number).sort((a, b) => a - b);
            if (positions.length === 0) return [{ pos: 0, val: '_' }];

            const minPos = Math.min(...positions, this.headPos) - 1;
            const maxPos = Math.max(...positions, this.headPos) + 1;

            const arr = [];
            for (let i = minPos; i <= maxPos; i++) {
                arr.push({ pos: i, val: this.tape[i] || '_' });
            }
            return arr;
        }
    }

    // Build test case cards
    const testCases = challenge.test_cases || [];
    testCases.forEach((tc, idx) => {
        const card = document.createElement('div');
        card.className = 'test-case-card';
        card.dataset.index = idx;
        card.innerHTML = `
            <div class="test-case-header">
                <span class="test-input">Input: <code>${tc.input || '(empty)'}</code></span>
                <span class="test-status" id="status-${idx}">-</span>
            </div>
            <div class="test-case-body">
                <div class="test-details">
                    <div class="detail-box expected">
                        <div class="detail-label">Expected Output</div>
                        <div class="detail-value">${tc.expected}</div>
                    </div>
                    <div class="detail-box actual" id="actual-${idx}">
                        <div class="detail-label">Your Output</div>
                        <div class="detail-value" id="actual-value-${idx}">-</div>
                    </div>
                </div>
                <div class="test-reason">${tc.reason}</div>
                <button class="btn-secondary btn-small" style="margin-top: 0.5rem;" onclick="visualize(${idx})">Visualize</button>
            </div>
        `;
        testCasesGrid.appendChild(card);

        // Toggle expand on click
        card.querySelector('.test-case-header').addEventListener('click', () => {
            card.classList.toggle('expanded');
        });
    });

    // Run all tests
    document.getElementById('btn-run-all-tests').addEventListener('click', function() {
        let passed = 0;

        testCases.forEach((tc, idx) => {
            const sim = new TuringSimulator(rules);
            sim.reset(tc.input || '');
            const result = sim.run(1000);

            const card = document.querySelector(`.test-case-card[data-index="${idx}"]`);
            const statusEl = document.getElementById(`status-${idx}`);
            const actualEl = document.getElementById(`actual-${idx}`);
            const actualValueEl = document.getElementById(`actual-value-${idx}`);

            if (result.timeout) {
                statusEl.textContent = '⏱ Timeout';
                actualValueEl.textContent = 'Infinite loop?';
                card.classList.add('fail');
                card.classList.remove('pass');
            } else if (result.state !== 'DONE') {
                statusEl.textContent = '⚠ Did not finish';
                actualValueEl.textContent = `Stopped in ${result.state}`;
                card.classList.add('fail');
                card.classList.remove('pass');
            } else if (result.output === tc.expected) {
                statusEl.textContent = '✓ Pass';
                actualValueEl.textContent = result.output;
                actualEl.classList.add('correct');
                card.classList.add('pass');
                card.classList.remove('fail');
                passed++;
            } else {
                statusEl.textContent = '✗ Fail';
                actualValueEl.textContent = result.output;
                card.classList.add('fail');
                card.classList.remove('pass');
            }
        });

        // Show summary
        resultsSummary.classList.remove('hidden');
        resultsCount.textContent = `${passed}/${testCases.length} tests passed`;

        if (passed === testCases.length) {
            resultsStatus.textContent = 'SUCCESS!';
            resultsStatus.className = 'status pass';
            finalResult.classList.remove('hidden');
            document.getElementById('result-success').classList.remove('hidden');
            document.getElementById('result-failure').classList.add('hidden');
        } else {
            resultsStatus.textContent = 'NEEDS WORK';
            resultsStatus.className = 'status fail';
            finalResult.classList.remove('hidden');
            document.getElementById('result-success').classList.add('hidden');
            document.getElementById('result-failure').classList.remove('hidden');
        }
    });

    // Visualization
    let visualSim = null;
    let visualInterval = null;

    window.visualize = function(testIdx) {
        const tc = testCases[testIdx];
        visualSim = new TuringSimulator(rules);
        visualSim.reset(tc.input || '');
        visualSection.classList.remove('hidden');
        renderVisualization();
    };

    function renderVisualization() {
        if (!visualSim) return;

        const tape = document.getElementById('visual-tape');
        const tapeArr = visualSim.getTapeArray();

        tape.innerHTML = tapeArr.map(cell => `
            <div class="tape-cell ${cell.pos === visualSim.headPos ? 'head' : ''} ${cell.val === '_' ? 'blank' : ''}">
                ${cell.val === '_' ? '' : cell.val}
            </div>
        `).join('');

        document.getElementById('visual-state').textContent = visualSim.state;
        document.getElementById('visual-step').textContent = visualSim.steps;
    }

    document.getElementById('btn-step').addEventListener('click', function() {
        if (visualSim && !visualSim.halted) {
            visualSim.step();
            renderVisualization();
        }
    });

    document.getElementById('btn-run-slow').addEventListener('click', function() {
        if (visualInterval) clearInterval(visualInterval);
        visualInterval = setInterval(() => {
            if (visualSim && !visualSim.halted) {
                visualSim.step();
                renderVisualization();
            } else {
                clearInterval(visualInterval);
            }
        }, 500);
    });

    document.getElementById('btn-run-fast').addEventListener('click', function() {
        if (visualInterval) clearInterval(visualInterval);
        visualInterval = setInterval(() => {
            if (visualSim && !visualSim.halted) {
                visualSim.step();
                renderVisualization();
            } else {
                clearInterval(visualInterval);
            }
        }, 100);
    });

    document.getElementById('btn-reset-visual').addEventListener('click', function() {
        if (visualInterval) clearInterval(visualInterval);
        if (visualSim) {
            const currentInput = testCases[0]?.input || '';
            visualSim.reset(currentInput);
            renderVisualization();
        }
    });
});
</script>
{% endblock %}
