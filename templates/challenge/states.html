{% extends "base.html" %}

{% block title %}Define States - Challenge{% endblock %}

{% block content %}
<div class="challenge-page">
    <div class="challenge-container">
        <h1>Step 1: Design Your States</h1>

        <!-- Task reminder -->
        <div class="challenge-reminder" id="challenge-reminder">
            <!-- Challenge task reminder loads here -->
        </div>

        <!-- Clear explanation -->
        <div class="explanation-box">
            <h3>What Are States?</h3>
            <p><strong>States = what the machine "remembers"</strong></p>
            <p>The machine can only see ONE cell at a time. States let it remember what it has seen or what it's doing.</p>

            <div class="example-box">
                <strong>Example:</strong> To count if there's an even or odd number of 1s:
                <ul>
                    <li><code>EVEN</code> = "So far, I've seen an EVEN number of 1s"</li>
                    <li><code>ODD</code> = "So far, I've seen an ODD number of 1s"</li>
                </ul>
            </div>
        </div>

        <!-- System states (always present) -->
        <div class="system-states">
            <h3>System States (Always Present):</h3>
            <div class="state-row system">
                <span class="state-badge start">START</span>
                <span class="state-desc">Machine begins here. You'll define rules for this state.</span>
            </div>
            <div class="state-row system">
                <span class="state-badge done">DONE</span>
                <span class="state-desc">Machine stops here. Any state can "go to DONE" to finish.</span>
            </div>
        </div>

        <!-- User states builder -->
        <div class="states-builder">
            <h3>Your Working States:</h3>
            <p class="hint">What does your machine need to remember? Name your states clearly.</p>

            <!-- Suggested states from challenge -->
            <div class="suggested-states hidden" id="suggested-states">
                <p><strong>Suggested states for this challenge:</strong></p>
                <div id="suggested-states-list"></div>
            </div>

            <div id="states-list" class="user-states-list">
                <!-- Dynamic state inputs -->
            </div>

            <button id="btn-add-state" class="btn-secondary">+ Add Another State</button>
        </div>

        <!-- Navigation -->
        <div class="validation-section">
            <button id="btn-continue" class="btn-primary btn-large">Continue to Rules</button>
            <p class="note">You'll define what each state does next.</p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statesList = document.getElementById('states-list');
    const addStateBtn = document.getElementById('btn-add-state');
    const continueBtn = document.getElementById('btn-continue');
    const reminderDiv = document.getElementById('challenge-reminder');
    const suggestedDiv = document.getElementById('suggested-states');
    const suggestedList = document.getElementById('suggested-states-list');

    // Load challenge from session storage
    const challenge = JSON.parse(sessionStorage.getItem('currentChallenge') || '{}');

    if (challenge.task) {
        reminderDiv.innerHTML = `
            <p><strong>Your Task:</strong> ${challenge.task}</p>
            ${challenge.task_detail ? `<p>${challenge.task_detail}</p>` : ''}
        `;
    }

    // Show suggested states if available
    if (challenge.suggested_states && challenge.suggested_states.length > 0) {
        suggestedList.innerHTML = challenge.suggested_states.map(state =>
            `<button class="suggested-state-btn" data-state="${state}">${state}</button>`
        ).join('');
        suggestedDiv.classList.remove('hidden');

        // Click to add suggested state
        suggestedList.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggested-state-btn') && !e.target.classList.contains('used')) {
                const stateName = e.target.dataset.state;
                addState(stateName);
                e.target.classList.add('used');
            }
        });
    }

    function addState(name = '') {
        const div = document.createElement('div');
        div.className = 'user-state-row';
        div.innerHTML = `
            <input type="text" class="state-name-input" placeholder="STATE_NAME (e.g., SCANNING, COUNTING)" value="${name}">
            <button class="btn-remove" onclick="this.parentElement.remove(); updateSuggestedButtons();">×</button>
        `;
        statesList.appendChild(div);

        // Focus the new input if empty
        if (!name) {
            div.querySelector('input').focus();
        }
    }

    // Update suggested buttons when state is removed
    window.updateSuggestedButtons = function() {
        const usedStates = Array.from(document.querySelectorAll('.state-name-input'))
            .map(input => input.value.trim().toUpperCase());

        document.querySelectorAll('.suggested-state-btn').forEach(btn => {
            if (usedStates.includes(btn.dataset.state)) {
                btn.classList.add('used');
            } else {
                btn.classList.remove('used');
            }
        });
    };

    addStateBtn.addEventListener('click', () => addState());

    // Add initial empty state
    addState();

    continueBtn.addEventListener('click', function() {
        // Gather states - always include START
        const states = [{ name: 'START', isSystem: true }];

        document.querySelectorAll('.state-name-input').forEach(input => {
            const name = input.value.trim().toUpperCase();
            if (name && name !== 'START' && name !== 'DONE') {
                states.push({ name: name, isSystem: false });
            }
        });

        // Allow proceeding even with 0 working states (for trivial challenges)
        // But warn the user if they have no states
        if (states.length < 2) {
            const proceed = confirm('You have no working states. Some challenges can be solved with just START → DONE.\n\nDo you want to continue anyway?');
            if (!proceed) return;
        }

        // Store states for next step
        sessionStorage.setItem('challengeStates', JSON.stringify(states));

        // Clear any previous rules
        sessionStorage.removeItem('challengeRules');

        // Go to first state's rules (START)
        window.location.href = '/challenge/rules/START';
    });
});
</script>
{% endblock %}
