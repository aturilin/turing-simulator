{% extends "base.html" %}

{% block title %}Define States - Challenge{% endblock %}

{% block content %}
<div class="challenge-page">
    <div class="challenge-container">
        <h1>Step 1: What States Do You Need?</h1>

        <div class="challenge-reminder" id="challenge-reminder">
            <!-- Challenge task reminder loads here -->
        </div>

        <div class="states-builder">
            <p class="section-hint">States = what the machine needs to "remember". Think about what information changes as the machine works.</p>

            <div class="states-list-container">
                <div class="state-row header-row">
                    <span class="state-badge start">üèÅ START</span>
                    <span class="state-hint">(always begins here)</span>
                </div>

                <div id="states-list">
                    <!-- Dynamic state inputs -->
                </div>

                <button id="btn-add-state" class="btn-secondary">+ Add State</button>
            </div>
        </div>

        <div class="validation-section">
            <button id="btn-validate-states" class="btn-primary btn-large">Continue ‚Üí</button>
            <div class="feedback-box hidden" id="feedback-box">
                <p class="feedback-message" id="feedback-message"></p>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading-overlay hidden" id="loading-overlay">
            <div class="spinner"></div>
            <p>AI is checking your states...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statesList = document.getElementById('states-list');
    const addStateBtn = document.getElementById('btn-add-state');
    const validateBtn = document.getElementById('btn-validate-states');
    const feedbackBox = document.getElementById('feedback-box');
    const feedbackMessage = document.getElementById('feedback-message');
    const loadingOverlay = document.getElementById('loading-overlay');
    const reminderDiv = document.getElementById('challenge-reminder');

    // Load challenge from session storage
    const challenge = JSON.parse(sessionStorage.getItem('currentChallenge') || '{}');
    if (challenge.task) {
        reminderDiv.innerHTML = `<p><strong>Task:</strong> ${challenge.task}</p>`;
    }

    function addState(name = '') {
        const div = document.createElement('div');
        div.className = 'state-row';
        div.innerHTML = `
            <input type="text" class="state-name-input" placeholder="STATE_NAME" value="${name}">
            <button class="btn-remove" onclick="this.parentElement.remove();">√ó</button>
        `;
        statesList.appendChild(div);
    }

    addStateBtn.addEventListener('click', () => addState());

    // Add one empty state by default
    addState();

    validateBtn.addEventListener('click', async function() {
        // Gather states
        const states = [{ name: 'START' }];

        document.querySelectorAll('.state-name-input').forEach(input => {
            const name = input.value.trim().toUpperCase();
            if (name && name !== 'START') {
                states.push({ name: name });
            }
        });

        if (states.length < 2) {
            feedbackBox.classList.remove('hidden');
            feedbackMessage.innerHTML = '<span class="error">Add at least one more state besides START!</span>';
            return;
        }

        // Store states for next step
        sessionStorage.setItem('challengeStates', JSON.stringify(states));

        loadingOverlay.classList.remove('hidden');
        feedbackBox.classList.add('hidden');

        try {
            const response = await fetch('/api/challenge/validate-states', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    challenge: challenge,
                    states: states
                })
            });

            const result = await response.json();
            feedbackBox.classList.remove('hidden');

            if (result.valid) {
                feedbackMessage.innerHTML = `<span class="success">‚úì ${result.feedback}</span>`;
                setTimeout(() => {
                    window.location.href = '/challenge/rules/START';
                }, 1000);
            } else {
                feedbackMessage.innerHTML = `<span class="hint">${result.feedback}</span>`;
            }

        } catch (error) {
            feedbackMessage.innerHTML = '<span class="error">Error checking states. Please try again.</span>';
            feedbackBox.classList.remove('hidden');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}
